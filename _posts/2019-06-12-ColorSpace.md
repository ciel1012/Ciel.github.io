---
layout:     post
title:      "Color Space"
subtitle:   "\"伽马和线性颜色空间\""
date:       2019-06-12
author:     "Ciel"
header-img: "img/post-bg-rtr.jpg"
catalog: true
mathjax: true
tags:
    - 笔记
---

> PBR有一个很重要的要求，就是要在线性空间中进行计算。要搞清楚线性工作流，就要先清楚伽马校正的概念。

# 伽马空间和线性空间

看了许多谈论伽马空间与线性空间的文章，大致有这几方面原因：

#### 历史原因

在早期，CRT几乎是唯一的显示设备。但是CRT输入的电压和显示出来的亮度不是线性关系。显示器电压和亮度的关系大约如下图黄色曲线，所以典型的CRT显示器大致自带一个有伽马值的幂曲线，这类伽马称为display gamma。由于这个问题的存在，那么图像捕捉设备就需要进行一个伽马校正，它们使用的伽马叫做encoding gamma，大约是下图蓝色曲线。而encoding gamma和display gamma的乘积就是整个图像系统的end-to-end gamma。
![伽马曲线](/img/in-post/color-space/gamaquxian.jpg)

虽然现在CRT设备很少见了，但为了保证这种感知一致性（这是它一直沿用至今的很重要的一点），同时也为了对已有图像的兼容性（之前很多图像使用了encoding gamma对图像进行了编码），所以仍在使用这种伽马编码。而且，虽然现在的LCD并不存在这个特点，但是为了保证兼容性，也做了和CRT一样的非线性特性。
再来看一张图：
![伽马空间](/img/in-post/color-space/gamakongjian.jpg)
右边的图像就是原始图片显示在显示器上后我们看到的，因为显示器自带的伽马变换（通常伽马值为2.2），图片会比它本身的亮度要暗。而左边的图片在图片输出前，通常是在保存图片的时候做了伽马值为0.45的伽马校正。现实中绝大部分的图片都是被伽马值为0.45校正过的，也就是说图片文件存储的都是伽马校正过的颜色值。做伽马校正几乎是每台相机、每个图像编辑软件在存储图像时默认要做的事。2.2为0.45的倒数，互相抵消得到了与原始一致的图像。如果图片没有做伽马纠正，显示的图像将是像右图一样，颜色被压黑。

#### 人眼特性原因

看到的文章里都说到，其实人眼对暗部的变化更加敏感，而对亮部变化其实不是很敏感。也就是说，从0亮度变到0.01亮度，人眼是可以察觉到的，但从0.99变到1.0，人眼可能就根本察觉不出来，觉得它们是一个颜色。如果做编码，亮部位数可以少一些，而暗部需要更多的位数。只看描述还是很难感觉到，可以看下这个[实验](https://www.cnblogs.com/guanzz/p/7416821.html)，有助于理解。

1. 在Photoshop中新建一张 500*150/分辨率75/颜色模式RGB 8位/背景白色 的图，然后从左到右,从黑到白，水平拉一条渐变，如图所示：

   ![8位](/img/in-post/color-space/8bit.jpg)

   图中的明暗分界线从人眼来看大概就在中间位置。用QQ截图工具可以发现大箭头指示，最黑的地方RGB（0,0,0）,最白的地方RGB(255,255,255)，而中间位置正好是RGB（128,128,128）。可以发现你的眼睛和电脑都认为渐变的中点也是中间亮度。

2. 在Photoshop中新建一张 500*150/分辨率75/颜色模式RGB 32位/背景白色 的图，然后从左到右,从黑到白，水平拉一条渐变，如图所示：

   ![32位](/img/in-post/color-space/32bit.jpg)

   我们知道了，从黑到白的渐变里，明暗分界线的色阶应该是RGB(128,128,128),现在我们在32位图里，用QQ截图工具找这个点，会发现RGB(128,128,128)出现在了渐变过程0.2的位置（红线位置）。此时也会发现32位渐变在人眼看来不如8位的渐变自然。

“黑少白多”其实只是人眼看起来是这样，正如前面说的人眼对暗部的变化更为敏感，如果你用Photoshop自带的取色工具会发现，32位图中依然是真实的线性渐变。

由此可以发现，其实在8位图中我们看到的明暗分界线其实也应该处于0.2的位置，之前的8位图其实是欺骗了我们。8位图其实是把原来0.2的位置转换成了0.5，这样暗部就有了更多色阶来存储，而亮部则舍弃了一些人眼可能感受不到的亮部色阶变化。

值为50的颜色不是是值为25的颜色亮度的两倍，大多数的美术人员都是工作在Gamma空间下的。

8位图因为储存空间较少，因此使用的就是Gamma校正过的颜色。在只有8bit的情况下，没有必要在亮部浪费过多，这样就可以表现更多暗部的细节变化，所以实际亮度只有0.2经过gamma校正后实际被编码成了0.5的像素值。

sRGB 颜色空间是一个可以直接用来在显示器上显示的非线性颜色空间。

#### 伽马校正

由上面的原因可以知道，如果直接将捕捉到的颜色保存到图片会有以下情况：

![\img\in-post\pbr\nocorrect](\img\in-post\pbr\nocorrect.jpg)

伽马校正定义如下：

![\img\in-post\pbr\gammacorrect](\img\in-post\pbr\gammacorrect.jpg)

因此往往把伽马校正这个阶段提前到图片存储的时候，显示器要让这个画面变暗，一亮一暗抵消了之后就是原来的亮度了，看到所有的图片也就正常了，不会普遍的偏暗，我们看着比较舒服的样子。

![\img\in-post\pbr\gamma](\img\in-post\pbr\gamma.jpg)

当然有时不同的显示器Gamma曲线可能也有不同，例如Mac的显示器的Gamma值为1.8.
