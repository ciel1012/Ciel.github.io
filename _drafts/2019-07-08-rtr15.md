---
layout:     post
title:      "Non-Photorealistic Rendering"
subtitle:   "\"《Real-Time Rendering 4th》笔记——第十五章 非真实感渲染\""
date:       2019-01-01
author:     "Ciel"
header-img: "img/post-bg-rtr.jpg"
catalog: true
mathjax: true
tags:
    - Real-Time Rendering
---

# Non-Photorealistic Rendering

> 本章首先详细讨论了实现卡通渲染风格的方法，然后讨论了NPR范围内的其他主题。最后介绍各种线条渲染技术。

非真实感渲染（NPR）也称为风格化渲染。NPR可以用来创建类似于技术说明的图像。只显示那些与特定应用程序的目标相关的细节。比如在修理时只高亮显示发动机的简单线条图。NPR的另一个领域是模拟绘画风格和天然媒介，例如，钢笔和墨水，木炭和水彩。这是一个巨大的领域，适用于各种各样的算法，试图捕捉各种媒体的感觉。考虑到这种宽度，这里主要关注绘制笔画和线条的技术，目标是给出一些用于实时NPR的算法。

![\img\in-post\rtr15\15-1](\img\in-post\rtr15\15-1.jpg)

原书图15.1，应用于咖啡机的各种非真实感渲染风格。

### 1卡通渲染

在NPR中，卡通渲染（cel / toon rendering）吸引了大量注意。因为这种风格具有幻想和童真内涵。最简单的方法是，用实线将不同的纯色区域分隔开来。这种风格流行的原因之一是，通过简化和去除杂乱，可以有放大与呈现相关信息的效果。对于卡通人物，更多观众会认同那些画得简单的风格。

toon渲染风格已经在计算机图形学中使用了几十年，将三维模型与二维cel动画集成在一起。与其它NPR相比，它易于设计，适合计算机自动生成。许多电子游戏都使用它来达到良好的效果。

![\img\in-post\rtr15\15-2](\img\in-post\rtr15\15-2.jpg)

原书图15.2，一个实时渲染NPR游戏例子，Okami(大神)

- 物体的轮廓通常被渲染成黑色，这样可以放大卡通效果。下一节将描述查找和渲染描边的概要。

- 有几种方法来处理卡通材质表面着色。最常见的两种方法是用纯色(非亮色)填充网格区域，或者使用两种色调，分别表示亮区和阴影区。双色调方法，有时称为hard shading，在像素着色器中很容易执行，当法线和光源方向的点积超过某个值时，使用较浅的颜色，如果不超过某个值，则使用较深的色调。当光照更复杂时，另一种方法是量化最终图像本身。也称为色调分离(posterization)，这是一个取一系列连续的值并转换为几个色调的过程，每个色调之间有一个急剧的变化。量化RGB值可能会导致不愉快的色调变化，因为每个单独的通道都以与其他通道不密切相关的方式发生变化。使用HSV、HSL或Y'CbCr等保色空间是更好的选择。使用设计好的一维函数或纹理可以将强度级别重新映射为特定的色调或颜色。纹理也可以使用量化或其他过滤器进行预处理。图15.16显示了另一个具有更多颜色级别的示例。

![\img\in-post\rtr15\15-3](\img\in-post\rtr15\15-3.jpg)

原书图15.3，左边的基本渲染依次应用了实体填充、色调分离和铅笔着色技术。

- [Barla](https://hal.inria.fr/inria-00362888/document/)等人通过使用二维图代替一维阴影纹理来添加依赖于视图的效果。第二个维度是由表面的深度或方向决定的。例如，当物体距离较远或快速移动时，它可以平滑地软化。这个算法，结合了其他各种着色方程和绘制纹理，被用于游戏《军团要塞2》中，以提供卡通和现实风格的混合。toon着色器的变化可以用于其他目的，例如在可视化表面或地形上的特征时，可以放大对比度。

### 2轮廓线(Outline)渲染

用于cel边缘渲染的算法反映了NPR的一些主要主题和技术。下面会提供该领域风格的算法。使用的方法可以粗略地分类为基于表面着色，程序几何，图像处理，几何边缘检测或这些的混合。

- 有几种不同类型的边可以用于toon渲染：

  - 边界(boundary )或边缘是两个三角形不共享的边界，例如纸张的边缘。 实体对象通常没有边界。

  - 折痕(crease)、硬边或特征边是由两个三角形共享的，并且这两个三角形之间的夹角(称为二面角)大于某个预先确定的值。一个好的默认折痕角是60度。折痕边缘可以进一步细分为脊边和谷边。

  - 当共享它的两个三角形在材质上不同或以其他方式引起着色变化时，就会出现材质边缘(material edge )。它也可以是艺术家希望一直展示的边缘，例如，前额的线条，或者是将同一颜色的裤子和衬衫分开的一条线。

  - 轮廓边缘(contour edge )指两个相邻三角形与一些方向向量相比面向不同方向的边缘，通常是来自眼睛的一个方向向量。

  - 剪影边缘(silhouette edge)沿着物体轮廓的轮廓边，即它将目标从图像平面的背景中分离出来。

  这种分类基于文献中常用用法，但也有一些变化，我们所说的折痕和材料边缘有时在其他地方称为边界边缘(boundary edges )。

![\img\in-post\rtr15\15-4](\img\in-post\rtr15\15-4.jpg)

原书图15.4，顶部打开的盒子，正面有条纹。显示边界(B,boundary)、折痕(C,crease)、材质(M,material)和轮廓(S,silhouette)。根据所给的定义，没有一条边界(boundary)被认为是轮廓边(silhouette)，因为这些边只有一个邻接的多边形。

- 我们在这里区分contour 和silhouette 。两者都是边缘，表面的一部分面向观察者，另一部分面向外。Silhouette是contour的子集，Silhouette将物体与另一个物体或背景分开。例如，在头部的侧视图中，耳朵形成轮廓边缘(contour)，即使它们出现在头部的轮廓(silhouette)中。在一些早期文献中，contour边缘被称为silhouettes，但通常意味着完整的轮廓边缘类别。 此外，轮廓边(contour edges)不应与地形图上使用的轮廓线(contour lines)混淆。
- 注意，边界边缘(boundary edges)与轮廓线(contour)或剪影边缘(silhouette)不相同。轮廓和轮廓边缘由视图方向决定，而边界边缘与视图无关。暗示轮廓(Suggestive contours)由几乎是原始视点轮廓的位置形成。 它们提供额外的边缘，有助于传达物体的形状。虽然这里的重点主要是检测和绘制轮廓边缘，但已经为其他类型的笔画做了大量工作。主要是关注多边形模型的这种边。还有讨论寻找由细分曲面或其他高阶定义组成的模型轮廓的方法，在原书参考书目中。

![\img\in-post\rtr15\15-5](\img\in-post\rtr15\15-5.jpg)

原书15.5，从左到右:silhouette，contour，contour与suggestive contour edges。

#### 2.1着色法向轮廓边缘

- 可以使用法线与视线的点积来给出轮廓边缘。如果这个值接近于零，那么这个表面几乎与眼睛平行，所以很可能接近轮廓边缘。将这些区域涂成黑色，随着点积的增加，这些区域逐渐变成白色。在可编程着色器之前，该算法是使用带有黑环的球面环境映射实现的，或者将mipmap金字塔纹理的最顶层涂成黑色。现在这种类型的着色是直接在像素着色器中实现的，当屏幕法线垂直于视图方向时，将其变为黑色。

![\img\in-post\rtr15\15-6](\img\in-post\rtr15\15-6.jpg)

原书图15.6，当阴影法线垂直于视图方向时，通过使曲面变暗来修剪轮廓边缘。通过加大衰减角度，可以显示更粗的边缘。

- 这种着色在某种意义上与边缘光相反（其中边缘光照亮了物体的轮廓）;在这里，场景从眼睛的位置被照亮，并且下降被夸大，使边缘变暗。它也可以被认为是图像处理中的阈值滤波器，当图像的表面低于一定的强度时，图像就会被转换成黑色，否则就会被转换成白色。

- 这种方法的一个特点或缺点是，轮廓线是根据曲面的曲率绘制的，轮廓线宽度是可变的。这种方法适用于没有折痕边缘的曲面模型，例如，轮廓线附近的区域通常有法线几乎垂直于视图方向的像素。该算法在立方体这样的模型上会失败，因为折痕边缘附近的表面没有这个特性。即使在曲面上，它也会看起来很糟糕，因为当物体距离较远时，在轮廓边缘附近采样的一些法线可能并不垂直。尽管如此，Goodwin等人指出这一基本概念仍然具有作为视觉提示的有效性，并讨论了如何结合光照、曲率和距离来确定笔画厚度。

#### 2.2程序几何剪影

- 最早的实时轮廓边缘绘制技术之一是由Rossignac和van Emmerik提出的，后来由Raskar和Cohen改进。一般的想法是正常渲染正面，然后渲染背面，使其轮廓边缘可见。绘制这些背景的方法有很多种，每种方法都有自己的优缺点。每种方法的第一步都是绘制正面。然后打开正面剔除frontface culling，关闭背面剔除backface culling，这样就只渲染背面。

- 渲染轮廓的一种方法是只绘制背景的边缘(而不是面)。使用偏置或其他技术(第15.4节)确保这些线中的一些只是在正面绘制。这样，只有正面和背面相交的边缘才可见。

- 使这些线条更宽的一种方法是将背面本身渲染成黑色，再次向前倾斜。Raskar和Cohen给出了几种偏置方法，比如用固定的量平移，或者用补偿深度非线性量平移，或者使用深度-斜率偏置调用，比如OpenGL的glPolygonOffset。Lengyel讨论了如何通过修改透视图矩阵来提供更好的深度控制。所有这些方法的一个问题是，它们没有创建宽度相同的线。要做到这一点，向前移动的量不仅取决于背面，还取决于相邻的正面。如下图，背面的斜率可以用来使多边形向前偏置，但是线条的厚度也将取决于正面的角度。

![\img\in-post\rtr15\15-7](\img\in-post\rtr15\15-7.jpg)

原书图15.7，剪影的z偏差方法，通过向后平移背面来完成。如果正面处于不同的角度，如右图所示，可以看到不同程度的背面。

- Raskar和Cohen解决了这个邻居依赖问题，他们将每个背向三角形的边沿加厚，使之达到一致粗细的宽度。也就是说，三角形的斜率和与观察者的距离决定了三角形被扩展了多少。一种方法是将每个三角形的三个顶点沿其平面向外展开。绘制三角形的一个更安全的方法是将三角形的每条边向外移动并连接这些边。这样做可以避免顶点粘在远离原始三角形的地方。注意，此方法不需要任何偏置，因为后面板扩展到前面板的边缘之外。这种增大技术更加可控和一致，并已成功地应用于电子游戏中，如《波斯王子》(Prince of Persia)和《非洲武士》(Afro Samurai)。

![\img\in-post\rtr15\15-8](\img\in-post\rtr15\15-8.jpg)

原书图15.8，

![\img\in-post\rtr15\15-9](\img\in-post\rtr15\15-9.jpg)

原书图15.9，

#### 2.3图像处理边缘检测



#### 2.4几何轮廓边缘检测



### 3画笔表面样式

虽然toon渲染是一种流行样式，但还有无数其他样式可以应用于表面。


